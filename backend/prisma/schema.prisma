// SaaS Hotel Management System - Prisma Schema
// Multi-tenant: business_id + branch_id isolation
// All tables include audit fields

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CORE ENTITIES ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  language  String   @default("en") // en, sw
  isSuperAdmin        Boolean  @default(false)
  forcePasswordChange Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User can belong to multiple businesses
  businessUsers BusinessUser[]
  tasksCreated   Task[]     @relation("TaskCreatedBy")
  tasksCompleted Task[]     @relation("TaskCompletedByUser")
  taskReads      TaskRead[]

  @@map("users")
}

model BusinessUser {
  id         String   @id @default(cuid())
  userId     String
  businessId String
  role       String   // MANAGER, FRONT_OFFICE, BAR, RESTAURANT, KITCHEN, HOUSEKEEPING, FINANCE
  branchId   String?  @default("main")
  isDisabled Boolean  @default(false)
  createdAt  DateTime @default(now())
  createdBy  String?
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@map("business_users")
}

// Role-based staff workers (real people under a role). One role can have multiple workers.
model StaffWorker {
  id         String   @id @default(cuid())
  businessId String
  role       String   // MANAGER, FRONT_OFFICE, BAR, etc.
  fullName   String
  status     String   @default("ACTIVE") // ACTIVE, BLOCKED
  createdAt  DateTime @default(now())
  createdBy  String?
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tasksAssigned  Task[]     @relation("TaskTargetWorker")
  tasksCompleted Task[]     @relation("TaskCompletedByWorker")
  taskReads      TaskRead[]

  @@map("staff_workers")
}

model Business {
  id           String   @id @default(cuid())
  businessId   String   @unique // e.g. HMS-49281 - unique tenant identifier
  businessType String   // HOTEL, LODGE, BAR, RESTAURANT, TRANSPORT
  name         String
  location     String?
  phone        String?
  logoUrl      String?  @map("logo_url")
  quickbooksConnected Boolean @default(false) @map("quickbooks_connected")
  quickbooksRealmId   String? @map("quickbooks_realm_id")
  isSuspended  Boolean  @default(false)
  createdAt    DateTime @default(now())
  createdBy    String?
  updatedAt    DateTime @updatedAt

  businessUsers     BusinessUser[]
  subscription      Subscription?
  quickbooksTokens  QuickbooksToken[]
  syncLogs          SyncLog[]
  revenueCategories RevenueCategory[]
  otherRevenues     OtherRevenue[]
  roomCategories    RoomCategory[]
  rooms             Room[]
  bookings          Booking[]
  barItems          BarItem[]
  barOrders         BarOrder[]
  barRestocks       BarRestock[]
  restaurantItems   RestaurantItem[]
  restaurantOrders  RestaurantOrder[]
  inventoryItems    InventoryItem[]
  inventoryRestocks InventoryRestock[]
  maintenanceRequests MaintenanceRequest[]
  roomCleaningLogs   RoomCleaningLog[]
  laundryRequests   LaundryRequest[]
  expenses          Expense[]
  workers           Worker[]
  staffWorkers      StaffWorker[]
  payrollRecords    PayrollRecord[]
  settings          BusinessSetting[]
  roleMessages      RoleMessage[]
  tasks             Task[]
  taskReads         TaskRead[]
  adminAlerts       AdminAlert[]

  @@map("businesses")
}

model AdminAlert {
  id         String   @id @default(cuid())
  businessId String
  type       String   // MAINTENANCE_REQUEST, LAUNDRY_REQUEST, ROLE_MESSAGE
  title      String
  message    String   @db.Text
  entityType String?  // maintenance_request, laundry_request, etc.
  entityId   String?
  senderRole String
  senderId   String?
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  reads    AdminAlertRead[]

  @@index([businessId, createdAt])
  @@map("admin_alerts")
}

model AdminAlertRead {
  id        String   @id @default(cuid())
  alertId   String
  userId    String
  readAt    DateTime @default(now())

  alert AdminAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@unique([alertId, userId])
  @@index([userId])
  @@map("admin_alert_reads")
}

model BusinessSetting {
  id          String   @id @default(cuid())
  businessId  String
  key         String   // e.g. enableDragDropBooking
  value       String   @db.Text // JSON-serialized value
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, key])
  @@map("business_settings")
}

model Subscription {
  id               String   @id @default(cuid())
  businessId       String   @unique
  plan             String   // FRONT_OFFICE_ONLY, FRONT_AND_BACK
  status           String   @default("TRIAL") // TRIAL, ACTIVE, EXPIRED
  trialEndsAt      DateTime
  currentPeriodEnd DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ==================== HOTEL MODULE ====================

model RoomCategory {
  id          String   @id @default(cuid())
  businessId  String
  branchId    String   @default("main")
  name        String
  pricePerNight Decimal @db.Decimal(12, 2)
  description String?
  createdAt   DateTime @default(now())
  createdBy   String?
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  rooms    Room[]

  @@map("room_categories")
}

model Room {
  id            String   @id @default(cuid())
  businessId    String
  branchId      String   @default("main")
  categoryId    String
  roomNumber    String
  roomName      String?  // Optional display name
  status        String   @default("VACANT") // VACANT, OCCUPIED, RESERVED, UNDER_MAINTENANCE
  createdAt     DateTime @default(now())
  createdBy     String?
  updatedAt     DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category RoomCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  bookings Booking[]
  cleaningLogs RoomCleaningLog[]

  @@unique([businessId, branchId, categoryId, roomNumber])
  @@map("rooms")
}

model RoomCleaningLog {
  id                 String   @id @default(cuid())
  businessId         String
  branchId           String   @default("main")
  roomId             String
  cleanedByWorkerId  String?
  cleanedByWorkerName String?
  createdAt          DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  room     Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([businessId, roomId])
  @@index([businessId, createdAt])
  @@map("room_cleaning_logs")
}

model Booking {
  id          String    @id @default(cuid())
  businessId  String
  branchId    String    @default("main")
  roomId      String
  guestName   String
  guestPhone  String?
  checkIn     DateTime
  checkOut    DateTime
  nights      Int
  roomAmount  Decimal   @db.Decimal(12, 2) @map("room_amount")
  totalAmount Decimal   @db.Decimal(12, 2)
  currency    String    @default("TZS") // TZS, USD, etc.
  paymentMode String?   // CASH, BANK, MPESA, TIGOPESA, AIRTEL_MONEY
  status      String    @default("CONFIRMED") // CONFIRMED, CHECKED_IN, CHECKED_OUT, CANCELLED
  folioNumber String?
  quickbooksInvoiceId String? @map("quickbooks_invoice_id")
  createdAt   DateTime  @default(now())
  createdBy   String?
  createdByWorkerId   String?
  createdByWorkerName String?
  updatedAt   DateTime  @updatedAt

  business Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  room     Room           @relation(fields: [roomId], references: [id], onDelete: Restrict)
  payments FolioPayment[]
  otherRevenues OtherRevenue[]

  @@map("bookings")
}

model RevenueCategory {
  id                       String   @id @default(uuid())
  companyId                String   @map("company_id")
  name                     String
  linkedQuickBooksAccountId String? @map("linked_quickbooks_account_id")
  createdAt                DateTime @default(now()) @map("created_at")

  company Business @relation(fields: [companyId], references: [id], onDelete: Cascade)
  revenues OtherRevenue[]

  @@unique([companyId, name])
  @@index([companyId, createdAt])
  @@map("revenue_categories")
}

model OtherRevenue {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  bookingId   String?  @map("booking_id")
  categoryId  String   @map("category_id")
  description String?
  amount      Decimal  @db.Decimal(12, 2)
  paymentMethod String @map("payment_method") // CASH | BANK | CARD
  date        DateTime
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  company  Business         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  booking  Booking?         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  category RevenueCategory  @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([companyId, date])
  @@index([companyId, bookingId])
  @@index([companyId, categoryId])
  @@map("other_revenues")
}

model QuickbooksToken {
  id           String   @id @default(cuid())
  companyId    String   @map("company_id")
  accessToken  String   @map("access_token") @db.Text
  refreshToken String   @map("refresh_token") @db.Text
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  company Business @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId])
  @@map("quickbooks_tokens")
}

model SyncLog {
  id           String   @id @default(cuid())
  companyId    String   @map("company_id")
  entityType   String   @map("entity_type") // BOOKING | PAYMENT | BAR_SALE | EXPENSE
  entityId     String   @map("entity_id")
  status       String   // SUCCESS | FAILED
  errorMessage String?  @map("error_message") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  company Business @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([companyId, entityType])
  @@index([companyId, status])
  @@map("sync_logs")
}

model FolioPayment {
  id         String   @id @default(cuid())
  bookingId  String
  amount     Decimal  @db.Decimal(12, 2)
  paymentMode String   // CASH, BANK, MPESA, TIGOPESA, AIRTEL_MONEY
  createdAt  DateTime @default(now())
  createdBy  String?
  createdByRole String?
  createdByWorkerId String?
  createdByWorkerName String?

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("folio_payments")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  role        String
  businessId  String
  workerId    String?  // Staff worker who performed action
  workerName  String?  // e.g. "John Mtei" for display
  actionType  String   // booking_created, booking_checked_in, etc.
  entityType  String?  // booking, folio, room, etc.
  entityId    String?
  metadata    String?  @db.Text // JSON string for extra data
  createdAt   DateTime @default(now())

  @@map("audit_logs")
}

// ==================== BAR MODULE ====================

model BarItem {
  id            String   @id @default(cuid())
  businessId    String
  branchId      String   @default("main")
  name          String
  price         Decimal  @db.Decimal(12, 2)
  inventoryItemId String?
  createdAt     DateTime @default(now())
  createdBy     String?
  updatedAt     DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orders   BarOrderItem[]
  restockItems BarRestockItem[]

  @@map("bar_items")
}

model BarRestock {
  id               String   @id @default(cuid())
  businessId        String
  branchId          String   @default("main")
  createdAt         DateTime @default(now())
  createdById       String
  createdByRole     String
  createdByWorkerId   String?
  createdByWorkerName String?
  approvedById        String
  approvedByRole      String
  approvedByWorkerId   String?
  approvedByWorkerName String?
  approvedAt          DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items    BarRestockItem[]

  @@map("bar_restocks")
}

model BarRestockItem {
  id            String @id @default(cuid())
  restockId     String
  barItemId     String
  inventoryItemId String?
  stockBefore   Int
  quantityAdded Int
  stockAfter    Int

  restock BarRestock @relation(fields: [restockId], references: [id], onDelete: Cascade)
  barItem  BarItem   @relation(fields: [barItemId], references: [id], onDelete: Restrict)

  @@map("bar_restock_items")
}

model BarOrder {
  id            String   @id @default(cuid())
  businessId    String
  branchId      String   @default("main")
  orderNumber   String
  paymentMethod String   // CASH, MOBILE_MONEY, BANK
  customerName  String?  // optional; walk-in defaults applied in service
  totalAmount   Decimal  @db.Decimal(12, 2)
  createdById   String
  createdByRole String?  // BAR, MANAGER (for reporting)
  createdByWorkerId   String? // Selected staff worker id
  createdByWorkerName String? // Selected staff worker name
  createdAt     DateTime @default(now())

  business Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items    BarOrderItem[]

  @@map("bar_orders")
}

model BarOrderItem {
  id         String  @id @default(cuid())
  orderId    String
  barItemId  String
  quantity   Int
  unitPrice  Decimal @db.Decimal(12, 2)
  totalPrice Decimal @db.Decimal(12, 2)
  createdAt  DateTime @default(now())

  order   BarOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  barItem BarItem  @relation(fields: [barItemId], references: [id], onDelete: Restrict)

  @@map("bar_order_items")
}

// ==================== RESTAURANT MODULE ====================

model RestaurantItem {
  id            String   @id @default(cuid())
  businessId    String
  branchId      String   @default("main")
  name          String
  price         Decimal  @db.Decimal(12, 2)
  category      String?  // Optional grouping (e.g. "Breakfast", "Main", "Drinks")
  isEnabled     Boolean  @default(true)
  inventoryItemId String?
  createdAt     DateTime @default(now())
  createdBy     String?
  updatedAt     DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orders   RestaurantOrderItem[]

  @@map("restaurant_items")
}

model RestaurantOrder {
  id            String   @id @default(cuid())
  businessId    String
  branchId      String   @default("main")
  orderNumber   String
  paymentMethod String
  customerName  String?  // optional; walk-in defaults applied in service
  totalAmount   Decimal  @db.Decimal(12, 2)
  createdById   String
  createdByRole String?  // RESTAURANT, MANAGER (for accountability)
  createdByWorkerId   String?
  createdByWorkerName String?
  createdAt     DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items    RestaurantOrderItem[]

  @@map("restaurant_orders")
}

model RestaurantOrderItem {
  id               String  @id @default(cuid())
  orderId          String
  restaurantItemId String
  quantity         Int
  unitPrice        Decimal @db.Decimal(12, 2)
  totalPrice       Decimal @db.Decimal(12, 2)
  createdAt        DateTime @default(now())

  order          RestaurantOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  restaurantItem RestaurantItem   @relation(fields: [restaurantItemId], references: [id], onDelete: Restrict)

  @@map("restaurant_order_items")
}

// ==================== INVENTORY MODULE ====================

model InventoryItem {
  id          String   @id @default(cuid())
  businessId  String
  branchId    String   @default("main")
  name        String
  quantity    Int      @default(0)
  minQuantity Int      @default(5)
  unitPrice   Decimal  @db.Decimal(12, 2) @default(0)
  createdAt   DateTime @default(now())
  createdBy   String?
  updatedAt   DateTime @updatedAt

  business Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  restocks InventoryRestock[]

  @@map("inventory_items")
}

model InventoryRestock {
  id              String   @id @default(cuid())
  businessId      String
  branchId        String   @default("main")
  inventoryItemId String
  quantityAdded   Int
  oldQuantity     Int
  newQuantity     Int
  createdAt       DateTime @default(now())
  createdBy       String

  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@map("inventory_restocks")
}

// ==================== HOUSEKEEPING & MAINTENANCE ====================

model MaintenanceRequest {
  id          String   @id @default(cuid())
  businessId  String
  branchId    String   @default("main")
  roomId      String?
  description String
  type        String
  status      String   @default("PENDING")
  amount      Decimal? @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  createdBy   String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("maintenance_requests")
}

model LaundryRequest {
  id                  String    @id @default(cuid())
  businessId          String
  branchId            String    @default("main")
  roomNumber          String?
  item                String
  quantity            Int       @default(1)
  status              String    @default("REQUESTED") // REQUESTED, ASSIGNED, IN_PROGRESS, COMPLETED, DELIVERED
  createdByWorkerId   String?
  createdByWorkerName String?
  deliveredAt         DateTime?
  createdAt           DateTime  @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, createdAt])
  @@map("laundry_requests")
}

// ==================== FINANCE MODULE ====================

model Expense {
  id          String   @id @default(cuid())
  businessId  String
  branchId    String   @default("main")
  category    String
  amount      Decimal  @db.Decimal(12, 2)
  description String?
  expenseDate DateTime
  createdAt   DateTime @default(now())
  createdBy   String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

// ==================== WORKERS & PAYROLL ====================

model Worker {
  id            String   @id @default(cuid())
  businessId    String
  branchId      String   @default("main")
  name          String
  sector        String
  role          String
  monthlySalary Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now())
  createdBy     String?
  updatedAt     DateTime @updatedAt

  business Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  payroll  PayrollRecord[]

  @@map("workers")
}

model PayrollRecord {
  id          String   @id @default(cuid())
  businessId  String
  branchId    String   @default("main")
  workerId    String
  month       Int
  year        Int
  amount      Decimal  @db.Decimal(12, 2)
  status      String   @default("PENDING")
  paidAt      DateTime?
  createdAt   DateTime @default(now())
  createdBy   String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  worker   Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@map("payroll_records")
}

model RoleMessage {
  id           String   @id @default(cuid())
  businessId   String
  senderId     String   // User id who sent
  senderRole   String   // Role of sender at time of send
  recipientRole String  // Role to receive (e.g. BAR, FRONT_OFFICE)
  body         String   @db.Text
  createdAt    DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, createdAt])
  @@index([businessId, recipientRole])
  @@map("role_messages")
}

// ==================== TASKS (OPERATIONS) ====================

model Task {
  id             String   @id @default(cuid())
  businessId     String
  branchId       String   @default("main")
  type           String   // ANNOUNCEMENT | ASSIGNED
  title          String
  description    String?  @db.Text
  priority       String?  // LOW | MEDIUM | HIGH (assigned tasks)
  dueDate        DateTime?

  // Recipients
  isAllStaff     Boolean  @default(false)
  targetRole     String?
  targetWorkerId String?

  // Audit
  createdByUserId String
  createdByRole   String   @default("MANAGER")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Completion (assigned tasks)
  completedAt       DateTime?
  completedByUserId String?
  completedByWorkerId String?
  completionNote    String? @db.Text

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  targetWorker StaffWorker? @relation("TaskTargetWorker", fields: [targetWorkerId], references: [id], onDelete: SetNull)
  createdByUser User @relation("TaskCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  completedByUser User? @relation("TaskCompletedByUser", fields: [completedByUserId], references: [id], onDelete: SetNull)
  completedByWorker StaffWorker? @relation("TaskCompletedByWorker", fields: [completedByWorkerId], references: [id], onDelete: SetNull)

  reads TaskRead[]

  @@index([businessId, createdAt])
  @@index([businessId, type, createdAt])
  @@index([businessId, targetRole])
  @@index([businessId, targetWorkerId])
  @@index([businessId, dueDate])
  @@index([businessId, completedAt])
  @@map("tasks")
}

model TaskRead {
  id         String   @id @default(cuid())
  businessId String
  taskId     String
  workerId   String
  userId     String
  readAt     DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  task     Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  worker   StaffWorker @relation(fields: [workerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, workerId])
  @@index([businessId, readAt])
  @@index([businessId, workerId])
  @@map("task_reads")
}
